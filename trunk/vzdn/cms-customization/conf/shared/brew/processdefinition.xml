<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.1" name="scwf:Brew">
	<swimlane name="initiator" />
	<swimlane name="Brew">
		<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
			<pooledactors>
				#{people.getGroup('GROUP_Brew')}
			</pooledactors>
		</assignment>
	</swimlane>
	
	<start-state name="start">
		<!--  try changing it to  wcmwf:submitReviewTask-->
		<task name="scwf:submitReviewTask" swimlane="initiator" />
		<transition name="" to="initialise"></transition>
	</start-state>
	

	<decision name="initialise">
        <event type="node-enter">
            <script>
                <variable name="wcmwf_reviewCycle" access="write"/>
                <expression>wcmwf_reviewCycle = 1;</expression>
            </script>
        </event>        
        <transition name="" to="toverizonapproval" />
    </decision>
	
	

	<decision name="toverizonapproval">
       <event type="node-enter">
            <script>
               <variable name="wcmwf_reviewerCnt" access="write"/>
               <variable name="wcmwf_approveCnt" access="write"/>
               <expression>
                  wcmwf_reviewerCnt = 1;
                  wcmwf_approveCnt = 0;
               </expression>
            </script>
       </event>

       <transition name="sendtoapproval" to="sendtoapproval" />
    </decision>   
	
	
	<decision name="sendtoapproval">
       <transition name="endreview" to="endreview" />
       <transition name="verizonapprovalcalled" to="Verizon Approval">
       	<!--  change this reviwer count -->
         <condition>#{wcmwf_approveCnt &lt; wcmwf_reviewerCnt}</condition>
         <action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
            <runas>admin</runas>
            <script>
               <expression>   
                     for each (user in people.getMembers(people.getGroup('GROUP_Brew'), false)){
                        var mail = actions.create("mail");
                        mail.parameters.to = user.properties["cm:email"];
                        mail.parameters.subject = "Brew Content has been sent to you for Review."; 
                        mail.parameters.from = initiator.properties["cm:email"];
                        mail.parameters.text = "New content has been submitted and is awaiting your review!" + "\n" + "Description : \"" +    bpm_workflowDescription + "\"";
                        mail.execute(bpm_package);
                     }
               </expression>
            </script>
         </action>
       </transition>
    </decision>
	
	

	<task-node name="Verizon Approval">
		<task name="scwf:verizonReview" swimlane="Brew" />
		<transition name="Approve" to="sendtoapproval">
			<script>
				<variable name="wcmwf_approveCnt" access="read,write" />
				<expression>
					wcmwf_approveCnt = wcmwf_approveCnt + 1;
				</expression>
			</script>
		</transition>
		<transition name="Reject" to="endreview"></transition>
	</task-node>


	
	
	<decision name="endreview">
       <transition name="rejected" to="rejected" >
       <action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
            <runas>admin</runas>
            <script>
               <expression>   
                        var mail = actions.create("mail");
                        mail.parameters.to = initiator.properties["cm:email"];
                        mail.parameters.subject = "Brew Content Rejected"; 
                        mail.parameters.text = "User has Rejected the Content.!" + "\n" + "Comments : \"" +    token.comments.get(0).message + "\"" + "\n" + "Description : \"" +    bpm_workflowDescription + "\"";
                        mail.execute(bpm_package);
               </expression>
            </script>
         </action>
       
       </transition>
       <transition name="approved" to="onapprove">
       		<action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
            <runas>admin</runas>
            <script>
               <expression>   
                        var mail = actions.create("mail");
                        mail.parameters.to = initiator.properties["cm:email"];
                        mail.parameters.subject = "Brew Content Approved"; 
                        comment = "";
					   if (token.comments.size() > 0)
						comment = token.comments.get(0).message;
                        mail.parameters.text = "User has Approved the Content.!" + "\n" + "Comments : \"" +    token.comments.get(0).message + "\"" + "\n" + "Description : \"" +    bpm_workflowDescription + "\"";
                        mail.execute(bpm_package);
               </expression>
            </script>
         </action>
           <condition>#{wcmwf_approveCnt == 1}</condition>
       </transition>
    </decision> 
	
	<task-node name="rejected">
        <task name="scwf:revise" swimlane="initiator" />
        <transition name="abort" to="end" />
        <transition name="resubmit" to="toverizonapproval">        <!-- restart review process (next cycle) -->
           <script>
               <variable name="wcmwf_reviewCycle" access="read,write" />
               <expression>
                   wcmwf_reviewCycle = wcmwf_reviewCycle +1;
               </expression>
           </script>
        </transition>
    </task-node>

    <decision name="onapprove">
       <transition name="launchnow" to="submitted" />
       <transition name="launchpending" to="submitpending">
           <condition>#{wcmwf_launchDate != null}</condition>
       </transition>
    </decision>
	
	
	
	
	
	<task-node name="submitted">
        <event type="node-enter">
           <action class="org.alfresco.repo.avm.wf.AVMSubmitPackageHandler"/>
           <action class="org.alfresco.repo.avm.wf.AVMDeployHandler"/>
        </event>
        <task name="scwf:remove" swimlane="initiator" />
        <transition name="Done" to="end" />
    </task-node>

    <!--                 -->
    <!-- End the Process -->
    <!--                 -->

    <end-state name="end"/>
    
    <event type="process-end">
        <action class="org.alfresco.repo.avm.wf.AVMRemoveAllSrcWebappsHandler"/>
        <action class="org.alfresco.repo.avm.wf.AVMReleaseTestServerHandler"/>
        <action class="org.alfresco.repo.avm.wf.AVMRemoveWFStoreHandler"/>
    </event>
	
</process-definition>